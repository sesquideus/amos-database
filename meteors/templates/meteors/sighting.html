{% extends 'core/base.html' %}
{% load static meteor_tags %}
{% load static station_tags %}

{% block pagetitle %}
    <h2>Sighting {{ sighting.id }}</h2>
    <div class="controls">
        {% with previous=sighting.previous next=sighting.next %}
            {% if previous != None %}
                <a href="{% url 'sighting' id=previous %}">
                    <img src="{% static "pictures/previous.png" %}" alt="Previous" />
                </a>
            {% else %}
                <img src="{% static "pictures/previous-gray.png" %}" alt="This is the first sighting" />
            {% endif %}

            <a href="{% url 'admin:meteors_sighting_change' sighting.id %}">
                <img src="{% static "pictures/edit.png" %}" alt="Edit" />
            </a>

            <a href="{% url 'sighting' id=sighting.id %}" target="_blank">
                <img class="icon" src="{% static "pictures/icon-kml.png" %}" alt="View KML" />
            </a>
            
            {% if next != None %}
                <a href="{% url 'sighting' id=next %}">
                    <img src="{% static "pictures/next.png" %}" alt="Next" />
                </a>
            {% else %}
                <img src="{% static "pictures/next-gray.png" %}" alt="This is the last sighting" />
            {% endif %}
        {% endwith %}
    </div>
{% endblock pagetitle %}

{% block page %}
    <div>
        <p>
            {% if sighting.timestamp %}
                {{ sighting.timestamp|date:"Y-m-d, l" }}
            {% else %}
                <span class="unknown">unknown date</span>
            {% endif %}
        </p>
        <p>
            {% if sighting.meteor.id %}
                Meteor <a class="object-link meteor" href="{% url 'meteor' name=sighting.meteor.name %}">{{ sighting.meteor }}</a>
            {% else %}
                <span class="unknown">Unidentified meteor</span>
            {% endif %}
            observed from <a class="object-link station" href="{% url 'station' code=sighting.station.code %}" id="location-name">{{ sighting.station.name|default_if_none:"(unknown)" }}</a>
            by <span id="observer-name">
                {% if sighting.observer is None %}
                    <span class="unknown">unknown observer</span>
                {% else %}
                    {{ sighting.observer.name }}
                {% endif %}
            </span>
            at <span id="time">{{ sighting.timestamp|date:"Y-m-d H:i:s.u" }}</span>
        </p>
    </div>
    
    
    <div class="inner">
        <div class="info">
            <table>
                <thead>
                    <tr>
                        <th class="group" colspan="2">photometry</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>timestamp</td>
                        <td class="data time ar">{{ sighting.timestamp|date:"Y-m-d H:i:s.u" }}
                    </tr>
                    <tr>
                        <td>apparent magnitude</td>
                        <td class="data magnitude">{{ sighting.magnitude|magnitude }}</td>
                    </tr>
                    <tr>
                        <td>arc length</td>
                        <td class="data length">{{ sighting.arc_length|floatformat:2 }}°</td>
                    </tr>
                    <tr>
                        <td>distance to meteor centre</td>
                        <td class="data length">{{ sighting.distance|default_if_none:"&mdash;" }}</td>
                    </tr>
                </tbody>
            </table>

            <h3>Sky info</h3>
            <table>
                <thead>
                    <tr>
                        <th class="subgroup">object</th>
                        <th class="subgroup" colspan="2">altitude</th>
                        <th class="subgroup" colspan="2">azimuth</th>
                        <th class="subgroup">magnitude</th>
                    </tr>
                </thead>
                <tbody>
                    {% with sun=sighting.sun_position %}
                        <tr>
                            <td>Sun</td>
                            <td class="data sun" style="background-color: {{ sun.alt|altitude_colour_back }}; color: {{ sun.alt|altitude_colour_front }};">
                                <span class="suninfo standalone">
                                    {{ sun.alt|floatformat:1 }}°
                                </span>
                            </td>
                            <td class="data arrow" style="background-color: {{ sun.alt|altitude_colour_back }}; color: {{ sun.alt|altitude_colour_front }};">
                                <span class="arrow" style="transform: rotate({{ sun.alt|multiply:-1 }}deg);">&#8594;</span>
                            </td>
                            <td class="data sun">
                                <span>{{ sun.az|floatformat:1 }}°</span>
                            </td>
                            <td class="data arrow">
                                <span class="arrow" style="transform: rotate({{ sun.az|add:-90 }}deg);">&#8594;</span>
                            </td>
                            <td class="data sun">
                                -26.74<sup>m</sup>
                            </td>
                        </tr>
                    {% endwith %}
                    {% with moon=sighting.moon_position %}
                        <tr>
                            <td>Moon</td>
                            <td class="data moon" style="background-color: {{ moon.alt|altitude_colour_back }}; color: {{ moon.alt|altitude_colour_front }};">
                                <span class="mooninfo standalone">
                                    {{ moon.alt|floatformat:1 }}°
                                </span>
                            </td>
                            <td class="data arrow" style="background-color: {{ moon.alt|altitude_colour_back }}; color: {{ moon.alt|altitude_colour_front }};">
                                <span class="arrow" style="transform: rotate({{ moon.alt|multiply:-1 }}deg);">&#8594;</span>
                            </td>
                            <td class="data moon">
                                <span>{{ moon.az|floatformat:1 }}°</span>
                            </td>
                            <td class="data arrow">
                                <span class="arrow" style="transform: rotate({{ moon.az|add:-90 }}deg);">&#8594;</span>
                            </td>
                            <td class="data moon">
                                <span class="empty">not implemented</span>
                            </td>
                        </tr>
                    {% endwith %}
                </tbody>
            </table>

            <h3>Light curve</h3>
            <img class="chart" src="{% url 'sighting-light-curve' id=sighting.id %}" alt="Light curve" />

            <h3>Video frames ({{ sighting.frames.count }} total)</h3>
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>timestamp</th>
                        <th>time</th>
                        <th>magnitude</th>
                        <th>altitude</th>
                        <th>azimuth</th>
                    </tr>
                </thead>
                <tbody>
                    {% for frame in sighting.frames.all %}
                        <tr {% if frame.order == maxLight %}class="maxLight"{% endif %}>
                            <td class="data order">
                                <a href="{{ frame.get_absolute_url }}">{{ frame.order }}</a>
                            </td>
                            <td class="data time">
                                {{ frame.timestamp|date:"H:m:s.u"|default:"&mdash;" }}
                            </td>
                            <td class="data time">
                                {{ frame.flight_time.total_seconds|floatformat:3|default:"&mdash;" }} s
                            </td>
                            <td class="data magnitude">
                                {{ frame.magnitude|magnitude }}
                            </td>
                            <td class="data angle">
                                {{ frame.altitude|angle }}
                            </td>
                            <td class="data angle">{{ frame.azimuth|angle }}</td>
                        </tr>
                    {% empty %}
                        <tr class="empty">
                            <td colspan="6">There are no recorded video frames for this sighting.</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="preview">
            {% if sighting.composite %}
            <a href="{{ sighting.composite.url }}">
                <img class="sighting" src="{{ sighting.composite.url }}" alt="Image for sighting {{ sighting.id }} is missing" />
            </a>
            {% else %}
                <img class="sighting empty" src="{% static "no-image.svg" %} "/>
            {% endif %}
        </div>
    </div>

    
{% endblock %}
