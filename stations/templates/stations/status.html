{% extends 'core/base.html' %}
{% load station_tags %}
{% load tz %}

{% block pagetitle %}
<h2>AMOS network status</h2>
{% endblock pagetitle %}

{% block page %}
    <table class="alternating">
        <thead>
            <tr>
                <th>subnetwork</th>
                <th>code</th>
                <th>name</th>
                <th colspan="2">status</th>
                <th>local time</th>
                <th colspan="2">&#x2600;</th>
                <th colspan="2">last sighting</th>
                <th>admin</th>
            </tr>
        </thead>
        {% for subnetwork in subnetworks %}
            {% for station in subnetwork.stations_full %}
                <tr>
                    {% if forloop.first %}
                        <th class="subgroup" rowspan="{{ subnetwork.stations.count }}">
                            <a href="{{ subnetwork.get_absolute_url }}">{{ subnetwork.name }} ({{ subnetwork.code }})</a>
                        </th>
                    {% endif %}
                    {% with sun=station.sun_position report=station.last_report.0 status=station.get_current_status last_sighting=station.last_sighting.0 %}
                        <td class="station-code">
                            {{ station.code }}
                        </td>

                        <td class="station-name">
                            <a href="{{ station.get_absolute_url }}">{{ station.name }}</a>
                        </td>

                        <td class="status data">
                            <abbr class="{{ status.code }}" title="{{ status.get_description }}">
                                {{ status.short }}
                            </abbr>
                        </td>
                        <td class="status">
                            {% if station.last_report.0 %}
                                {{ report.timestamp|since_date_time|default:"&mdash;" }}
                            {% else %}
                                &mdash;
                            {% endif %}
                        </td>

                        <td id="{{ station.code }}-localtime" class="time c">
                            {% timezone station.timezone %}
                                <abbr title="{% now "Y-m-d" %}">{% now "H:i" %}</abbr>
                            {% endtimezone %}
                        </td>

                        <td id="{{ station.code }}-sunalt"
                            class="data angle altitude"
                            style="background-color: {{ sun.alt|altitude_colour_back }}; color: {{ sun.alt|altitude_colour_front }};">
                            {{ sun.alt|floatformat:1 }}°
                            <span class="sun arrow" style="transform: rotate({{ sun.alt|multiply:-1 }}deg);">&#8594;</span>
                        </td>
                        <td id="{{ station.code }}-sunaz" class="data angle azimuth">
                            {{ sun.az|floatformat:1 }}°
                            <span class="sun arrow" style="transform: rotate({{ sun.az|add:-90 }}deg);">&#8594;</span>
                        </td>

                        <td class="time">
                            {% if station.last_sighting.0 %}
                                <a href="{{ last_sighting.get_absolute_url }}">{{ last_sighting.timestamp|date:"Y-m-d H:i:s" }}</a>
                            {% else %}
                                <span class="empty">no sightings</span>
                            {% endif %}
                        </td>
                        <td class="time">
                            {% if station.last_sighting.0 %}
                                {{ last_sighting.timestamp|since_date_time }}
                            {% else %}
                                <span class="empty">never</span>
                            {% endif %}
                        </td>

                        <td class="c">
                            <a href="{% url 'admin:stations_station_change' station.id %}">edit</a>
                        </td>
                    {% endwith %}
                </tr>
            {% empty %}
                <tr>
                    <th class="subgroup">
                        <a href="{{ subnetwork.get_absolute_url }}">{{ subnetwork.name }} ({{ subnetwork.code }})</a>
                    </th>
                    <td colspan="10" class="empty">No stations are defined in this subnetwork.</td>
                </tr>
            {% endfor %}
        {% endfor %}
    </table>
{% endblock page %}
